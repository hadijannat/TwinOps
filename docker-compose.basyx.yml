# TwinOps Docker Compose - BaSyx Integration
# This configuration integrates with actual BaSyx AAS/Submodel repositories

version: "3.8"

services:
  # MQTT Broker
  mqtt:
    image: eclipse-mosquitto:2
    container_name: twinops-mqtt
    ports:
      - "1883:1883"
    volumes:
      - ./infra/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto-data:/mosquitto/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -h localhost -t '$$SYS/#' -C 1 -i healthcheck -W 3"]
      interval: 30s
      timeout: 10s
      retries: 3

  # BaSyx AAS Repository
  aas-repository:
    image: eclipsebasyx/aas-repository:2.0.0-SNAPSHOT
    container_name: basyx-aas-repository
    ports:
      - "8081:8081"
    environment:
      - basyx.aasrepository.feature.mqtt.enabled=true
      - mqtt.hostname=mqtt
      - mqtt.port=1883
      - basyx.cors.allowed-origins=*
    depends_on:
      mqtt:
        condition: service_healthy
    restart: unless-stopped

  # BaSyx Submodel Repository
  submodel-repository:
    image: eclipsebasyx/submodel-repository:2.0.0-SNAPSHOT
    container_name: basyx-submodel-repository
    ports:
      - "8082:8082"
    environment:
      - basyx.submodelrepository.feature.mqtt.enabled=true
      - mqtt.hostname=mqtt
      - mqtt.port=1883
      - basyx.cors.allowed-origins=*
    depends_on:
      mqtt:
        condition: service_healthy
    restart: unless-stopped

  # BaSyx AAS Environment (optional - for loading AAS from file)
  aas-environment:
    image: eclipsebasyx/aas-environment:2.0.0-SNAPSHOT
    container_name: basyx-aas-environment
    ports:
      - "8083:8081"
    environment:
      - basyx.environment=file:/aas/sample_aas_env.json
      - basyx.cors.allowed-origins=*
    volumes:
      - ./models:/aas:ro
    restart: unless-stopped

  # Operation Delegation Service
  opservice:
    build:
      context: .
      dockerfile: docker/opservice/Dockerfile
    container_name: twinops-opservice
    ports:
      - "8087:8087"
    environment:
      - TWINOPS_TWIN_BASE_URL=http://aas-repository:8081
      - TWINOPS_SUBMODEL_BASE_URL=http://submodel-repository:8082
      - TWINOPS_MQTT_BROKER_HOST=mqtt
      - TWINOPS_MQTT_BROKER_PORT=1883
      - TWINOPS_OPSERVICE_PORT=8087
    depends_on:
      - aas-repository
      - submodel-repository
    restart: unless-stopped

  # AI Agent
  agent:
    build:
      context: .
      dockerfile: docker/agent/Dockerfile
    container_name: twinops-agent
    ports:
      - "8080:8080"
    environment:
      - TWINOPS_TWIN_BASE_URL=http://aas-repository:8081
      - TWINOPS_SUBMODEL_BASE_URL=http://submodel-repository:8082
      - TWINOPS_MQTT_BROKER_HOST=mqtt
      - TWINOPS_MQTT_BROKER_PORT=1883
      - TWINOPS_REPO_ID=default
      - TWINOPS_AAS_ID=urn:example:aas:pump-001
      - TWINOPS_AGENT_PORT=8080
      - TWINOPS_LLM_PROVIDER=rules
      # Uncomment and set for LLM providers:
      # - TWINOPS_LLM_PROVIDER=anthropic
      # - TWINOPS_ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - agent-audit:/app/audit_logs
    depends_on:
      - aas-repository
      - submodel-repository
      - opservice
    restart: unless-stopped

  # BaSyx AAS Web UI (optional)
  aas-web-ui:
    image: eclipsebasyx/aas-gui:SNAPSHOT
    container_name: basyx-aas-web-ui
    ports:
      - "3000:3000"
    environment:
      - VITE_AAS_REGISTRY_PATH=http://localhost:8081
      - VITE_SUBMODEL_REGISTRY_PATH=http://localhost:8082
    depends_on:
      - aas-repository
      - submodel-repository
    restart: unless-stopped

volumes:
  mosquitto-data:
  agent-audit:

networks:
  default:
    name: twinops-basyx-network
